<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathology Report System - Dr. N C Patel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2c3e50;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(41, 128, 185, 0.15);
            padding: 35px;
            margin-bottom: 30px;
            position: relative;
            border: 1px solid #e0f0ff;
        }

        /* Header Styles */
        .header {
            text-align: center;
            border-bottom: 4px solid #3498db;
            padding-bottom: 25px;
            margin-bottom: 30px;
            page-break-inside: avoid;
            background: linear-gradient(to right, #f8fcff, #ffffff);
            border-radius: 10px 10px 0 0;
            padding: 25px;
        }

        .clinic-name {
            color: #2c3e50;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 15px;
            letter-spacing: 1.2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .doctor-info {
            color: #34495e;
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.8;
        }

        .doctor-info strong {
            color: #2980b9;
            font-size: 17px;
        }

        .address {
            color: #5d6d7e;
            font-size: 14px;
            margin-bottom: 5px;
            padding: 8px;
            background: #f8fcff;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .reg-no {
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
            margin-top: 8px;
            padding: 6px 12px;
            background: #fff5f5;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid #ffcccc;
        }

        /* Patient Info Form */
        .patient-form {
            background: linear-gradient(135deg, #f8fcff 0%, #e8f4ff 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #3498db;
            margin-bottom: 30px;
            page-break-inside: avoid;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }

        .form-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8f4ff;
        }

        .form-title i {
            color: #3498db;
            background: #e8f4ff;
            padding: 10px;
            border-radius: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            padding-left: 5px;
            border-left: 3px solid #3498db;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0f0ff;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }

        /* Test Sections */
        .test-section {
            margin-bottom: 18px;
            border: 2px solid #e0f0ff;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .test-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .section-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 18px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
        }

        .section-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h3 i {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
        }

        .toggle-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .toggle-btn.collapsed {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .section-content.expanded {
            padding: 25px;
            max-height: 3000px;
        }

        .test-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
        }

        .test-table th {
            background: linear-gradient(135deg, #e8f4ff 0%, #d4e7ff 100%);
            text-align: left;
            padding: 16px 20px;
            border-bottom: 3px solid #3498db;
            color: #2c3e50;
            font-weight: 700;
            font-size: 15px;
        }

        .test-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f7ff;
            transition: background 0.3s;
        }

        .test-table tr:not(.empty-row):hover {
            background-color: #f8fcff;
        }

        .test-name {
            font-weight: 600;
            color: #2c3e50;
            width: 40%;
        }

        .test-input input, .test-input select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0f0ff;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            transition: all 0.3s;
        }

        .test-input select {
            background-color: white;
        }

        .test-input input:focus, .test-input select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .test-input input:not(:placeholder-shown), .test-input select:not([value=""]) {
            background: #f0f9ff;
            border-color: #a5d8ff;
        }

        .normal-value {
            color: #27ae60;
            font-size: 14px;
            width: 35%;
            font-weight: 500;
        }

        .units {
            color: #7f8c8d;
            font-size: 13px;
            font-style: italic;
            margin-left: 5px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid #f0f7ff;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f639b 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7b7d 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(149, 165, 166, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #219653 0%, #1e8449 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        /* Print Preview Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 95%;
            height: 95%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #3498db;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .modal-action-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f5f5f5;
        }

        #printPreviewFrame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Print Styles - FIXED FOR EVERY PAGE FOOTER */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 12pt;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                width: 210mm !important;
                height: 297mm !important;
                position: relative;
            }

            .container {
                box-shadow: none !important;
                padding: 10mm 15mm 30mm 15mm !important; /* Increased bottom padding */
                margin: 0 !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                min-height: 247mm !important; /* A4: 297mm - margins */
                position: relative !important;
                page-break-inside: avoid !important;
                border: 1px solid #ddd !important;
            }

            .no-print {
                display: none !important;
            }

            .header {
                border-bottom: 2px solid #3498db !important;
                padding-bottom: 8px !important;
                margin-bottom: 12px !important;
                page-break-after: avoid !important;
                background: white !important;
            }

            .clinic-name {
                font-size: 20pt !important;
                margin-bottom: 6px !important;
                background: linear-gradient(45deg, #2c3e50, #3498db) !important;
                -webkit-background-clip: text !important;
                -webkit-text-fill-color: transparent !important;
                background-clip: text !important;
            }

            .doctor-info {
                font-size: 9pt !important;
                line-height: 1.4 !important;
                margin-bottom: 6px !important;
            }

            .address, .reg-no {
                font-size: 8pt !important;
            }

            .reg-no {
                background: white !important;
                border: 1px solid #ddd !important;
            }

            /* Patient info for print */
            .print-patient-info {
                display: block !important;
                background: #f8fcff !important;
                padding: 12px 15px !important;
                margin-bottom: 15px !important;
                border: 2px solid #e0f0ff !important;
                border-radius: 8px !important;
                page-break-inside: avoid !important;
                font-size: 10pt !important;
            }

            .print-patient-info table {
                width: 100% !important;
                table-layout: fixed !important;
                font-size: 10pt !important;
            }

            .print-patient-info td {
                padding: 6px 8px !important;
                vertical-align: top !important;
                word-wrap: break-word !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .print-patient-info .label {
                font-weight: bold !important;
                color: #2c3e50 !important;
                width: 20% !important;
                min-width: 70px !important;
            }

            /* Test sections for print */
            .test-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                margin-bottom: 15px !important;
                border: 2px solid #e0f0ff !important;
                border-radius: 8px !important;
                display: none !important;
            }

            .test-section.has-filled-tests {
                display: block !important;
            }

            .section-header {
                background: #e8f4ff !important;
                color: #2c3e50 !important;
                border-bottom: 2px solid #3498db !important;
                padding: 12px 15px !important;
                font-size: 11pt !important;
            }

            .toggle-btn {
                display: none !important;
            }

            .section-content {
                display: block !important;
                max-height: none !important;
                padding: 15px !important;
            }

            .test-table {
                font-size: 9.5pt !important;
                width: 100% !important;
            }

            .test-table th {
                background: #e8f4ff !important;
                color: #2c3e50 !important;
                font-weight: bold !important;
                padding: 10px 12px !important;
                font-size: 10pt !important;
                border-bottom: 2px solid #3498db !important;
            }

            .test-table td {
                padding: 9px 12px !important;
                border-bottom: 1px solid #f0f7ff !important;
                font-size: 9.5pt !important;
            }

            /* Hide empty test rows */
            .test-row.empty-row {
                display: none !important;
            }

            /* Print result display */
            .print-result {
                display: inline !important;
                font-weight: bold !important;
                color: #2c3e50 !important;
            }

            .print-result-units {
                display: inline !important;
                font-size: 8.5pt !important;
                margin-left: 4px !important;
                color: #7f8c8d !important;
            }

            /* Additional notes */
            .additional-notes {
                background: #fff8e1 !important;
                padding: 15px !important;
                border-left: 5px solid #f39c12 !important;
                margin-top: 20px !important;
                font-size: 10pt !important;
                page-break-inside: avoid !important;
            }

            /* FIXED: Print footer appears on EVERY PAGE */
            .print-footer {
                display: block !important;
                position: fixed !important; /* Changed from absolute to fixed */
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                padding: 8px 15mm !important;
                font-size: 7.5pt !important;
                color: #5d6d7e !important;
                border-top: 2px solid #e0f0ff !important;
                background: white !important;
                z-index: 100 !important;
                text-align: center !important;
                height: 20mm !important;
                box-sizing: border-box !important;
                page-break-inside: avoid !important;
            }

            .print-footer-content {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                height: 100% !important;
            }

            .footer-left, .footer-center, .footer-right {
                flex: 1 !important;
                padding: 0 8px !important;
            }

            .footer-left {
                text-align: left !important;
            }

            .footer-center {
                text-align: center !important;
                border-left: 1px solid #eee !important;
                border-right: 1px solid #eee !important;
            }

            .footer-right {
                text-align: right !important;
            }

            .print-footer p {
                margin: 2px 0 !important;
                line-height: 1.3 !important;
            }

            .print-footer strong {
                color: #2c3e50 !important;
            }

            /* Hide on-screen footer when printing */
            .screen-footer {
                display: none !important;
            }

            /* Ensure compact layout */
            .test-name {
                width: 45% !important;
            }
            
            .test-input {
                width: 20% !important;
            }
            
            .normal-value {
                width: 35% !important;
                font-size: 9.5pt !important;
                color: #27ae60 !important;
            }
            
            .units {
                font-size: 8.5pt !important;
            }
            
            /* Set page margins - CRITICAL for fixed footer */
            @page {
                margin: 15mm 15mm 25mm 15mm !important; /* Bottom margin for footer space */
                size: A4 !important;
            }
            
            /* Adjust content to avoid footer overlap */
            body > .container:last-child {
                padding-bottom: 30mm !important;
            }
        }

        /* Footer */
        .print-footer {
            display: none;
        }

        .screen-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0f0ff;
            color: #5d6d7e;
            font-size: 13px;
            background: #f8fcff;
            padding: 20px;
            border-radius: 10px;
        }

        .screen-footer strong {
            color: #2c3e50;
        }

        .print-patient-info {
            display: none;
        }

        /* Print-specific result display */
        .print-result {
            display: none;
        }

        /* Additional Notes */
        .additional-notes {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f39c12;
            margin-top: 30px;
            page-break-inside: avoid;
        }

        .notes-title {
            color: #e67e22;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background: #2ecc71;
        }

        .filled-count {
            background: #e8f4ff;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #3498db;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Dropdown specific styles */
        .dropdown-result {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .positive {
            background: #ffeaea;
            color: #e74c3c;
        }

        .negative {
            background: #eaffea;
            color: #27ae60;
        }

        .weak-positive {
            background: #fff4e5;
            color: #f39c12;
        }

        .detected {
            background: #ffeaea;
            color: #e74c3c;
        }

        .not-detected {
            background: #eaffea;
            color: #27ae60;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .test-table {
                display: block;
                overflow-x: auto;
            }

            .btn {
                padding: 12px 25px;
                font-size: 14px;
            }
            
            .container {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="clinic-name">AVINASH HOSPITAL</h1>
            <div class="doctor-info">
                <p><strong>Dr. N C Patel</strong> MBBS, DMCW, MD (Pathology & Microbiology)</p>
                <p>Consultant Pathologist: Avinash Hospital, Bishra Road, Rourkela</p>
            </div>
            <div class="address">
                <p>Pathology Clinic Address: Avinash Hospital, Bishra Road Rourkela-769001</p>
            </div>
            <div class="reg-no">Registration No: 917/08</div>
        </div>

        <!-- Patient Information Form -->
        <div class="patient-form no-print">
            <h2 class="form-title"><i class="fas fa-user-injured"></i> Patient Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="slNo">Serial Number</label>
                    <input type="text" id="slNo" placeholder="Enter serial number">
                </div>
                <div class="form-group">
                    <label for="reportDate">Date</label>
                    <input type="date" id="reportDate" value="">
                </div>
                <div class="form-group">
                    <label for="referenceNo">Reference No.</label>
                    <input type="text" id="referenceNo" placeholder="Enter reference number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="patientName">Patient Name</label>
                    <input type="text" id="patientName" placeholder="Enter patient name">
                </div>
                <div class="form-group">
                    <label for="patientSex">Sex</label>
                    <select id="patientSex">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="patientAge">Age</label>
                    <input type="text" id="patientAge" placeholder="Enter age">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="doctorName">Referring Doctor</label>
                    <input type="text" id="doctorName" placeholder="Enter doctor's name">
                </div>
                <div class="form-group">
                    <label for="sampleType">Sample Type</label>
                    <input type="text" id="sampleType" value="Blood" placeholder="Sample type">
                </div>
            </div>
            <div class="form-group">
                <label for="clinicalNotes">Clinical Notes</label>
                <textarea id="clinicalNotes" placeholder="Enter clinical notes or indications..."></textarea>
            </div>
        </div>

        <!-- Print Patient Info (hidden on screen) -->
        <div class="print-patient-info" id="printPatientInfo">
            <table>
                <tr>
                    <td class="label">Serial No:</td>
                    <td id="printSlNo"></td>
                    <td class="label">Date:</td>
                    <td id="printDate"></td>
                    <td class="label">Ref. No:</td>
                    <td id="printReferenceNo"></td>
                </tr>
                <tr>
                    <td class="label">Patient Name:</td>
                    <td id="printPatientName"></td>
                    <td class="label">Sex/Age:</td>
                    <td id="printSexAge"></td>
                    <td class="label">Sample:</td>
                    <td id="printSampleType"></td>
                </tr>
                <tr>
                    <td class="label">Referred by:</td>
                    <td id="printDoctorName" colspan="5"></td>
                </tr>
            </table>
        </div>

        <!-- Test Sections -->
        <div id="testSections">
            <!-- General Tests Section -->
            <div class="test-section" id="section-generalTests">
                <div class="section-header" onclick="toggleSection('generalTests')">
                    <h3><i class="fas fa-vial"></i> GENERAL TESTS <span class="filled-count" id="count-generalTests">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="generalTests">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="generalTestsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Lipid Profile Section -->
            <div class="test-section" id="section-lipidProfile">
                <div class="section-header" onclick="toggleSection('lipidProfile')">
                    <h3><i class="fas fa-chart-pie"></i> LIPID PROFILE <span class="filled-count" id="count-lipidProfile">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="lipidProfile">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="lipidProfileBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Hematology Section -->
            <div class="test-section" id="section-hematology">
                <div class="section-header" onclick="toggleSection('hematology')">
                    <h3><i class="fas fa-tint"></i> HEMATOLOGY <span class="filled-count" id="count-hematology">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="hematology">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="hematologyBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Serology/Infectious Diseases Section -->
            <div class="test-section" id="section-serology">
                <div class="section-header" onclick="toggleSection('serology')">
                    <h3><i class="fas fa-virus"></i> SEROLOGY / INFECTIOUS DISEASES <span class="filled-count" id="count-serology">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="serology">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="serologyBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Enzymes Section -->
            <div class="test-section" id="section-enzymes">
                <div class="section-header" onclick="toggleSection('enzymes')">
                    <h3><i class="fas fa-atom"></i> ENZYMES <span class="filled-count" id="count-enzymes">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="enzymes">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="enzymesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Liver Function Test Section -->
            <div class="test-section" id="section-liverFunction">
                <div class="section-header" onclick="toggleSection('liverFunction')">
                    <h3><i class="fas fa-liver"></i> LIVER FUNCTION TEST <span class="filled-count" id="count-liverFunction">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="liverFunction">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="liverFunctionBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Renal Function Test Section -->
            <div class="test-section" id="section-renalFunction">
                <div class="section-header" onclick="toggleSection('renalFunction')">
                    <h3><i class="fas fa-kidneys"></i> RENAL FUNCTION TEST <span class="filled-count" id="count-renalFunction">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="renalFunction">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="renalFunctionBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Thyroid Function Test Section -->
            <div class="test-section" id="section-thyroidFunction">
                <div class="section-header" onclick="toggleSection('thyroidFunction')">
                    <h3><i class="fas fa-gland"></i> THYROID FUNCTION TEST <span class="filled-count" id="count-thyroidFunction">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="thyroidFunction">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="thyroidFunctionBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Cardiac Markers Section -->
            <div class="test-section" id="section-cardiacMarkers">
                <div class="section-header" onclick="toggleSection('cardiacMarkers')">
                    <h3><i class="fas fa-heartbeat"></i> CARDIAC MARKERS <span class="filled-count" id="count-cardiacMarkers">0</span></h3>
                    <button class="toggle-btn collapsed">▼</button>
                </div>
                <div class="section-content" id="cardiacMarkers">
                    <table class="test-table">
                        <thead>
                            <tr>
                                <th width="40%">Test Name</th>
                                <th width="25%">Test Result</th>
                                <th width="35%">Normal Value</th>
                            </tr>
                        </thead>
                        <tbody id="cardiacMarkersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Additional Notes Section -->
            <div class="additional-notes no-print">
                <h3 class="notes-title"><i class="fas fa-sticky-note"></i> Additional Notes</h3>
                <div class="form-group">
                    <textarea id="additionalNotes" placeholder="Enter any additional notes, observations, or comments..."></textarea>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="patient-form no-print" style="margin-top: 30px;">
            <h2 class="form-title"><i class="fas fa-chart-line"></i> Report Summary</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Total Tests Filled:</label>
                    <div style="font-size: 24px; font-weight: bold; color: #3498db; padding: 10px; text-align: center; background: #f8fcff; border-radius: 8px;">
                        <span id="totalFilledTests">0</span> / <span id="totalTests">150</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Print Preview Status:</label>
                    <div style="padding: 15px; background: #f8fcff; border-radius: 8px; border-left: 4px solid #3498db;">
                        <p style="margin-bottom: 8px;"><span class="status-indicator"></span> Empty rows will be hidden in print</p>
                        <p style="margin-bottom: 8px;"><span class="status-indicator" style="background: #3498db;"></span> Only filled sections will appear</p>
                        <p><span class="status-indicator" style="background: #27ae60;"></span> Footer appears on every page</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <button class="btn btn-secondary" onclick="clearAll()">
                <i class="fas fa-broom"></i> Clear All
            </button>
            <button class="btn btn-warning" onclick="printPreview()">
                <i class="fas fa-eye"></i> Print Preview
            </button>
            <button class="btn btn-success" onclick="saveAsJSON()">
                <i class="fas fa-file-code"></i> Save as JSON
            </button>
            <button class="btn btn-danger" onclick="saveAsPDF()">
                <i class="fas fa-file-pdf"></i> Save as PDF
            </button>
            <button class="btn btn-primary" onclick="printReport()">
                <i class="fas fa-print"></i> Print Report
            </button>
        </div>

        <!-- Screen Footer -->
        <div class="screen-footer no-print">
            <p><strong>Dr. N C Patel</strong> | Bishra Road, Rourkela-769001 | Reg. No: 917/08</p>
            <p>For any queries, please contact the pathology laboratory. | Email: drsangita.pathology@example.com | Phone: 0661-252787</p>
        </div>

        <!-- Print Footer - INSIDE THE CONTAINER for proper positioning -->
        <div class="print-footer" id="printFooter">
            <div class="print-footer-content">
                <div class="footer-left">
                    <p>Report Generated: <span id="footerDate"></span></p>
                    <p>Serial No: <span id="footerSlNo"></span> | Ref: <span id="footerReferenceNo"></span></p>
                </div>
                <div class="footer-center">
                    <p><strong>Dr. N C Patel</strong></p>
                    <p>MBBS, DMCW, MD (Pathology & Microbiology)</p>
                    <p>Bishra Road, Rourkela-1 | Reg. No: 917/08</p>
                </div>
                <div class="footer-right">
                    <p>Signature: _________________</p>
                    <p><i class="fas fa-stamp"></i> Hospital Stamp</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal-overlay" id="printPreviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-print"></i> Print Preview</h2>
                <div class="modal-actions">
                    <button class="modal-action-btn" onclick="printFromPreview()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="modal-action-btn" onclick="savePDFFromPreview()">
                        <i class="fas fa-file-pdf"></i> Save as PDF
                    </button>
                    <button class="close-modal" onclick="closePrintPreview()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <iframe id="printPreviewFrame"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Test data with normal values - Expanded with complete hematology and serology tests
        const tests = {
            generalTests: [
                { id: 1, name: "Plasma Glucose(F)", normalValue: "70-100", units: "mg/dL" },
                { id: 2, name: "Plasma Glucose(PP)", normalValue: "<140", units: "mg/dL" },
                { id: 3, name: "Plasma Glucose(R)", normalValue: "70-140", units: "mg/dL" },
                { id: 4, name: "Serum Urea", normalValue: "15-40", units: "mg/dL" },
                { id: 5, name: "Serum Creatinine", normalValue: "0.6-1.2", units: "mg/dL" },
                { id: 6, name: "Serum Uric Acid", normalValue: "2.4-6.0", units: "mg/dL" },
                { id: 7, name: "Sodium (Na+)", normalValue: "135-145", units: "mmol/L" },
                { id: 8, name: "Potassium (K+)", normalValue: "3.5-5.0", units: "mmol/L" },
                { id: 9, name: "Chloride (Cl-)", normalValue: "98-106", units: "mmol/L" },
                { id: 10, name: "Bicarbonate (HCO3-)", normalValue: "22-28", units: "mmol/L" },
                { id: 11, name: "Inorganic Phosphate", normalValue: "2.5-4.5", units: "mg/dL" },
                { id: 43, name: "Serum Osmolality", normalValue: "275-295", units: "mOsm/kg" },
                { id: 44, name: "Anion Gap", normalValue: "8-16", units: "mmol/L" }
            ],
            lipidProfile: [
                { id: 12, name: "Serum Cholesterol", normalValue: "<200", units: "mg/dL" },
                { id: 13, name: "Serum Triglycerides", normalValue: "<150", units: "mg/dL" },
                { id: 14, name: "Serum HDL Cholesterol", normalValue: "40-60", units: "mg/dL" },
                { id: 15, name: "LDL Cholesterol", normalValue: "<100", units: "mg/dL" },
                { id: 16, name: "VLDL Cholesterol", normalValue: "5-40", units: "mg/dL" },
                { id: 17, name: "Total:HDL Ratio", normalValue: "<5", units: "ratio" },
                { id: 18, name: "Phospholipids", normalValue: "150-380", units: "mg/dL" },
                { id: 19, name: "Serum Amylase", normalValue: "25-125", units: "U/L" },
                { id: 20, name: "Serum Calcium (Total)", normalValue: "8.5-10.5", units: "mg/dL" },
                { id: 45, name: "Serum Magnesium", normalValue: "1.7-2.2", units: "mg/dL" },
                { id: 46, name: "Lipoprotein(a)", normalValue: "<30", units: "mg/dL" }
            ],
            hematology: [
                { id: 100, name: "Haemoglobin", normalValue: "M: 13-17, F: 12-15", units: "g/dL" },
                { id: 101, name: "Total RBC Count", normalValue: "M: 4.5-6.0, F: 4.0-5.5", units: "million/μL" },
                { id: 102, name: "PCV / Hematocrit", normalValue: "M: 40-54, F: 36-48", units: "%" },
                { id: 103, name: "MCV", normalValue: "80-100", units: "fL" },
                { id: 104, name: "MCH", normalValue: "27-33", units: "pg" },
                { id: 105, name: "MCHC", normalValue: "31.5-34.5", units: "g/dL" },
                { id: 106, name: "Total WBC Count", normalValue: "4000-11000", units: "/μL" },
                { id: 107, name: "Neutrophils", normalValue: "40-80", units: "%" },
                { id: 108, name: "Lymphocytes", normalValue: "20-40", units: "%" },
                { id: 109, name: "Monocytes", normalValue: "2-10", units: "%" },
                { id: 110, name: "Eosinophils", normalValue: "1-6", units: "%" },
                { id: 111, name: "Basophils", normalValue: "0-2", units: "%" },
                { id: 112, name: "Platelet Count", normalValue: "150,000-450,000", units: "/μL" },
                { id: 113, name: "ESR (Westergren)", normalValue: "M: 0-15, F: 0-20", units: "mm/hr" },
                { id: 114, name: "Reticulocyte Count", normalValue: "0.5-2.5", units: "%" },
                { id: 115, name: "Peripheral Smear", normalValue: "Normocytic Normochromic", units: "" },
                { id: 116, name: "Bleeding Time", normalValue: "2-7", units: "minutes" },
                { id: 117, name: "Clotting Time", normalValue: "5-10", units: "minutes" },
                { id: 118, name: "Prothrombin Time (PT)", normalValue: "11-13.5", units: "seconds" },
                { id: 119, name: "INR", normalValue: "0.8-1.2", units: "ratio" },
                { id: 120, name: "APTT", normalValue: "25-35", units: "seconds" },
                { id: 121, name: "D-Dimer", normalValue: "<0.5", units: "μg/mL" },
                { id: 122, name: "Fibrinogen", normalValue: "200-400", units: "mg/dL" }
            ],
            serology: [
                { 
                    id: 200, 
                    name: "Malaria Antigen Test", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Weak Positive", "Plasmodium vivax", "Plasmodium falciparum", "Mixed Infection"] 
                },
                { 
                    id: 201, 
                    name: "Dengue NS1 Antigen", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Weak Positive"] 
                },
                { 
                    id: 202, 
                    name: "Dengue IgG", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Borderline"] 
                },
                { 
                    id: 203, 
                    name: "Dengue IgM", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Borderline"] 
                },
                { 
                    id: 204, 
                    name: "HIV I & II", 
                    normalValue: "Non-Reactive", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Non-Reactive", "Reactive", "Indeterminate"] 
                },
                { 
                    id: 205, 
                    name: "HBsAg (Hepatitis B)", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Weak Reactive"] 
                },
                { 
                    id: 206, 
                    name: "Anti-HCV (Hepatitis C)", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Weak Reactive"] 
                },
                { 
                    id: 207, 
                    name: "VDRL/RPR", 
                    normalValue: "Non-Reactive", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Non-Reactive", "Reactive", "Weak Reactive"] 
                },
                { 
                    id: 208, 
                    name: "Widal Test", 
                    normalValue: "<1:80", 
                    units: "titer", 
                    inputType: "dropdown", 
                    options: ["<1:80", "1:80", "1:160", "1:320", "1:640", ">1:640"] 
                },
                { 
                    id: 209, 
                    name: "Typhidot IgM", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Borderline"] 
                },
                { 
                    id: 210, 
                    name: "Typhidot IgG", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Borderline"] 
                },
                { 
                    id: 211, 
                    name: "COVID-19 Antibody", 
                    normalValue: "Negative", 
                    units: "", 
                    inputType: "dropdown", 
                    options: ["Negative", "Positive", "Borderline"] 
                },
                { 
                    id: 212, 
                    name: "ASO Titre", 
                    normalValue: "<200", 
                    units: "IU/mL", 
                    inputType: "dropdown", 
                    options: ["<200", "200-400", ">400"] 
                },
                { 
                    id: 213, 
                    name: "RA Factor", 
                    normalValue: "<14", 
                    units: "IU/mL", 
                    inputType: "dropdown", 
                    options: ["<14", "14-20", ">20"] 
                },
                { 
                    id: 214, 
                    name: "CRP", 
                    normalValue: "<6", 
                    units: "mg/L", 
                    inputType: "dropdown", 
                    options: ["<6", "6-10", ">10"] 
                }
            ],
            enzymes: [
                { id: 21, name: "Serum GOT/AST", normalValue: "8-40", units: "U/L" },
                { id: 22, name: "Serum CPK", normalValue: "10-120", units: "U/L" },
                { id: 23, name: "CPK-MB", normalValue: "0-25", units: "U/L" },
                { id: 24, name: "LDH", normalValue: "140-280", units: "U/L" },
                { id: 25, name: "Acid Phosphatase (Total)", normalValue: "2.5-12", units: "U/L" },
                { id: 26, name: "Non-Prostatic Acid Phosphatase", normalValue: "1.5-4.5", units: "U/L" },
                { id: 27, name: "Prostatic Acid Phosphatase", normalValue: "0-3.5", units: "U/L" },
                { id: 47, name: "Alkaline Phosphatase", normalValue: "44-147", units: "U/L" },
                { id: 48, name: "GGT (Gamma GT)", normalValue: "9-48", units: "U/L" },
                { id: 49, name: "5'-Nucleotidase", normalValue: "2-17", units: "U/L" }
            ],
            liverFunction: [
                { id: 28, name: "Serum Bilirubin (Total)", normalValue: "0.3-1.2", units: "mg/dL" },
                { id: 29, name: "Serum Bilirubin (Conjugated)", normalValue: "0.1-0.4", units: "mg/dL" },
                { id: 30, name: "Serum Bilirubin (Unconjugated)", normalValue: "0.2-0.8", units: "mg/dL" },
                { id: 31, name: "Alkaline Phosphatase", normalValue: "44-147", units: "U/L" },
                { id: 32, name: "Serum GPT/ALT", normalValue: "7-56", units: "U/L" },
                { id: 33, name: "Serum GGT", normalValue: "9-48", units: "U/L" },
                { id: 34, name: "Serum Proteins (Total)", normalValue: "6.0-8.0", units: "g/dL" },
                { id: 35, name: "Serum Albumin", normalValue: "3.5-5.0", units: "g/dL" },
                { id: 36, name: "Serum Globulin", normalValue: "2.5-3.5", units: "g/dL" },
                { id: 37, name: "A/G Ratio", normalValue: "1.0-2.0", units: "ratio" },
                { id: 38, name: "C.S.F Protein", normalValue: "15-45", units: "mg/dL" },
                { id: 39, name: "C.S.F Sugar", normalValue: "50-80", units: "mg/dL" },
                { id: 40, name: "Urine Protein (Random)", normalValue: "<30", units: "mg/dL" },
                { id: 41, name: "Urine Volume /24hrs", normalValue: "800-2000", units: "mL" },
                { id: 42, name: "Urine Protein", normalValue: "<150", units: "mg/24h" }
            ],
            renalFunction: [
                { id: 50, name: "Blood Urea Nitrogen", normalValue: "7-20", units: "mg/dL" },
                { id: 51, name: "Serum Creatinine", normalValue: "0.6-1.2", units: "mg/dL" },
                { id: 52, name: "GFR (Estimated)", normalValue: ">90", units: "mL/min" },
                { id: 53, name: "Urine Creatinine", normalValue: "500-2000", units: "mg/24h" },
                { id: 54, name: "Creatinine Clearance", normalValue: "85-125", units: "mL/min" },
                { id: 55, name: "Microalbuminuria", normalValue: "<30", units: "mg/24h" },
                { id: 56, name: "Urine Albumin/Creatinine", normalValue: "<30", units: "mg/g" },
                { id: 57, name: "BUN/Creatinine Ratio", normalValue: "10-20", units: "ratio" },
                { id: 58, name: "Serum Cystatin C", normalValue: "0.5-1.0", units: "mg/L" }
            ],
            thyroidFunction: [
                { id: 59, name: "TSH", normalValue: "0.4-4.0", units: "μIU/mL" },
                { id: 60, name: "Free T3", normalValue: "2.3-4.2", units: "pg/mL" },
                { id: 61, name: "Free T4", normalValue: "0.8-1.8", units: "ng/dL" },
                { id: 62, name: "Total T3", normalValue: "80-200", units: "ng/dL" },
                { id: 63, name: "Total T4", normalValue: "4.5-12.5", units: "μg/dL" },
                { id: 64, name: "Thyroglobulin", normalValue: "3-40", units: "ng/mL" },
                { id: 65, name: "Thyroid Antibodies", normalValue: "Negative", units: "", inputType: "dropdown", options: ["Negative", "Positive"] },
                { id: 66, name: "Reverse T3", normalValue: "10-24", units: "ng/dL" }
            ],
            cardiacMarkers: [
                { id: 67, name: "Troponin I", normalValue: "<0.04", units: "ng/mL" },
                { id: 68, name: "Troponin T", normalValue: "<0.01", units: "ng/mL" },
                { id: 69, name: "CK-MB", normalValue: "0-25", units: "U/L" },
                { id: 70, name: "Myoglobin", normalValue: "25-72", units: "ng/mL" },
                { id: 71, name: "BNP", normalValue: "<100", units: "pg/mL" },
                { id: 72, name: "NT-proBNP", normalValue: "<125", units: "pg/mL" },
                { id: 73, name: "hs-CRP", normalValue: "<3.0", units: "mg/L" },
                { id: 74, name: "Homocysteine", normalValue: "5-15", units: "μmol/L" },
                { id: 75, name: "Lipoprotein(a)", normalValue: "<30", units: "mg/dL" }
            ]
        };

        // Initialize the test tables
        document.addEventListener('DOMContentLoaded', function() {
            populateTestTables();
            
            // Set today's date as default
            const today = new Date();
            document.getElementById('reportDate').value = today.toISOString().split('T')[0];
            
            // Expand first section by default
            toggleSection('generalTests');
            toggleSection('hematology');
            
            // Add input listeners
            addInputListeners();
            
            // Update total tests count
            let totalTests = 0;
            for (const section in tests) {
                totalTests += tests[section].length;
            }
            document.getElementById('totalTests').textContent = totalTests;
        });

        // Populate test tables with print-ready structure
        function populateTestTables() {
            for (const section in tests) {
                const tableBody = document.getElementById(section + 'Body');
                if (!tableBody) continue;
                
                tableBody.innerHTML = '';
                
                tests[section].forEach(test => {
                    const row = document.createElement('tr');
                    row.className = 'test-row empty-row';
                    
                    // Check if this test needs a dropdown
                    if (test.inputType === 'dropdown') {
                        row.innerHTML = `
                            <td class="test-name">${test.id}. ${test.name}</td>
                            <td class="test-input">
                                <select id="test_${test.id}" 
                                        data-test-id="${test.id}" 
                                        data-units="${test.units}"
                                        onchange="updateRowDisplay(this)">
                                    <option value="">Select</option>
                                    ${test.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                                <span class="print-result" id="print_test_${test.id}"></span>
                                <span class="print-result-units" id="print_units_${test.id}"></span>
                            </td>
                            <td class="normal-value">
                                ${test.normalValue} <span class="units">${test.units}</span>
                            </td>
                        `;
                    } else {
                        // Regular numeric input
                        row.innerHTML = `
                            <td class="test-name">${test.id}. ${test.name}</td>
                            <td class="test-input">
                                <input type="text" id="test_${test.id}" placeholder="Enter value" 
                                       data-test-id="${test.id}" data-units="${test.units}"
                                       oninput="updateRowDisplay(this)">
                                <span class="print-result" id="print_test_${test.id}"></span>
                                <span class="print-result-units" id="print_units_${test.id}"></span>
                            </td>
                            <td class="normal-value">
                                ${test.normalValue} <span class="units">${test.units}</span>
                            </td>
                        `;
                    }
                    tableBody.appendChild(row);
                });
            }
        }

        // Add input listeners
        function addInputListeners() {
            document.querySelectorAll('.test-input input, .test-input select').forEach(input => {
                input.addEventListener('input', function() {
                    updateRowDisplay(this);
                });
                input.addEventListener('change', function() {
                    updateRowDisplay(this);
                });
            });
        }

        // Update row display based on input
        function updateRowDisplay(input) {
            const value = input.value.trim();
            const row = input.closest('.test-row');
            const testId = input.dataset.testId;
            const section = input.closest('.test-section').id.replace('section-', '');
            
            if (value) {
                row.classList.remove('empty-row');
                // Update print display with appropriate styling for dropdowns
                const printResult = document.getElementById(`print_test_${testId}`);
                const printUnits = document.getElementById(`print_units_${testId}`);
                
                printResult.textContent = value;
                printUnits.textContent = input.dataset.units;
                
                // Apply styling based on value for dropdowns
                if (input.tagName === 'SELECT') {
                    const lowerValue = value.toLowerCase();
                    printResult.className = 'print-result dropdown-result';
                    if (lowerValue.includes('positive')) {
                        printResult.classList.add('positive');
                    } else if (lowerValue.includes('negative') || lowerValue.includes('non-reactive')) {
                        printResult.classList.add('negative');
                    } else if (lowerValue.includes('weak') || lowerValue.includes('borderline')) {
                        printResult.classList.add('weak-positive');
                    } else if (lowerValue.includes('reactive') || lowerValue.includes('detected')) {
                        printResult.classList.add('detected');
                    }
                }
            } else {
                row.classList.add('empty-row');
                // Clear print display
                document.getElementById(`print_test_${testId}`).textContent = '';
                document.getElementById(`print_test_${testId}`).className = 'print-result';
                document.getElementById(`print_units_${testId}`).textContent = '';
            }
            
            // Update section visibility
            updateSectionVisibility(input.closest('.test-section'));
            
            // Update filled count
            updateFilledCount(section);
            
            // Update total filled count
            updateTotalFilledCount();
        }

        // Update section visibility
        function updateSectionVisibility(section) {
            const filledRows = section.querySelectorAll('.test-row:not(.empty-row)');
            if (filledRows.length > 0) {
                section.classList.add('has-filled-tests');
            } else {
                section.classList.remove('has-filled-tests');
            }
        }

        // Update filled count for a section
        function updateFilledCount(sectionId) {
            const section = document.getElementById(`section-${sectionId}`);
            if (!section) return;
            
            const filledRows = section.querySelectorAll('.test-row:not(.empty-row)');
            const countElement = document.getElementById(`count-${sectionId}`);
            if (countElement) {
                countElement.textContent = filledRows.length;
            }
        }

        // Update total filled count
        function updateTotalFilledCount() {
            let totalFilled = 0;
            document.querySelectorAll('.test-row:not(.empty-row)').forEach(() => {
                totalFilled++;
            });
            document.getElementById('totalFilledTests').textContent = totalFilled;
        }

        // Toggle section expand/collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggleBtn = section.previousElementSibling.querySelector('.toggle-btn');
            
            section.classList.toggle('expanded');
            toggleBtn.classList.toggle('collapsed');
        }

        // Clear all inputs
        function clearAll() {
            if (confirm('Are you sure you want to clear all test values? This cannot be undone.')) {
                document.querySelectorAll('.test-input input, .test-input select').forEach(input => {
                    input.value = '';
                    updateRowDisplay(input);
                });
                
                document.getElementById('slNo').value = '';
                document.getElementById('patientName').value = '';
                document.getElementById('patientAge').value = '';
                document.getElementById('patientSex').value = '';
                document.getElementById('referenceNo').value = '';
                document.getElementById('doctorName').value = '';
                document.getElementById('sampleType').value = 'Blood';
                document.getElementById('clinicalNotes').value = '';
                document.getElementById('additionalNotes').value = '';
                
                const today = new Date();
                document.getElementById('reportDate').value = today.toISOString().split('T')[0];
                
                // Reset all counts
                for (const section in tests) {
                    updateFilledCount(section);
                }
                updateTotalFilledCount();
            }
        }

        // Generate HTML for print version
        function generatePrintHTML() {
            // Collect patient info
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            const referenceNo = document.getElementById('referenceNo').value.trim();
            const reportDateInput = document.getElementById('reportDate').value;
            const patientSex = document.getElementById('patientSex').value;
            const patientAge = document.getElementById('patientAge').value;
            const doctorName = document.getElementById('doctorName').value.trim();
            const sampleType = document.getElementById('sampleType').value.trim();
            const clinicalNotes = document.getElementById('clinicalNotes').value.trim();
            const additionalNotes = document.getElementById('additionalNotes').value.trim();
            
            let reportDate;
            if (reportDateInput) {
                const dateObj = new Date(reportDateInput);
                reportDate = dateObj.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } else {
                reportDate = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }
            
            // Start building HTML
            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Pathology Report - ${patientName}</title>
                <style>
                    @media print {
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            padding: 0;
                            margin: 0;
                            font-size: 12pt;
                            color: #2c3e50;
                            width: 210mm;
                            height: 297mm;
                            position: relative;
                        }
                        
                        .print-container {
                            padding: 15mm 15mm 30mm 15mm;
                            position: relative;
                            min-height: 247mm;
                            box-sizing: border-box;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #3498db;
                            padding-bottom: 8px;
                            margin-bottom: 12px;
                            page-break-after: avoid;
                        }
                        
                        .clinic-name {
                            font-size: 20pt;
                            margin-bottom: 6px;
                            color: #2c3e50;
                            font-weight: 800;
                        }
                        
                        .doctor-info {
                            font-size: 9pt;
                            line-height: 1.4;
                            margin-bottom: 6px;
                        }
                        
                        .address, .reg-no {
                            font-size: 8pt;
                        }
                        
                        .reg-no {
                            background: #fff5f5;
                            padding: 3px 8px;
                            border-radius: 10px;
                            display: inline-block;
                            border: 1px solid #ffcccc;
                        }
                        
                        .print-patient-info {
                            background: #f8fcff;
                            padding: 10px 15px;
                            margin-bottom: 15px;
                            border: 2px solid #e0f0ff;
                            border-radius: 8px;
                            page-break-inside: avoid;
                            font-size: 10pt;
                        }
                        
                        .print-patient-info table {
                            width: 100%;
                            font-size: 10pt;
                        }
                        
                        .print-patient-info td {
                            padding: 6px 8px;
                        }
                        
                        .print-patient-info .label {
                            font-weight: bold;
                            color: #2c3e50;
                            width: 20%;
                            min-width: 70px;
                        }
                        
                        .test-section {
                            break-inside: avoid;
                            page-break-inside: avoid;
                            margin-bottom: 15px;
                            border: 2px solid #e0f0ff;
                            border-radius: 8px;
                        }
                        
                        .section-header {
                            background: #e8f4ff;
                            color: #2c3e50;
                            border-bottom: 2px solid #3498db;
                            padding: 12px 15px;
                            font-size: 11pt;
                            font-weight: bold;
                        }
                        
                        .section-content {
                            padding: 15px;
                        }
                        
                        .test-table {
                            font-size: 9.5pt;
                            width: 100%;
                            border-collapse: collapse;
                        }
                        
                        .test-table th {
                            background: #e8f4ff;
                            color: #2c3e50;
                            font-weight: bold;
                            padding: 10px 12px;
                            font-size: 10pt;
                            border-bottom: 2px solid #3498db;
                        }
                        
                        .test-table td {
                            padding: 9px 12px;
                            border-bottom: 1px solid #f0f7ff;
                            font-size: 9.5pt;
                        }
                        
                        .test-row.empty-row {
                            display: none;
                        }
                        
                        .test-name {
                            width: 45%;
                            font-weight: 600;
                        }
                        
                        .test-input {
                            width: 20%;
                        }
                        
                        .normal-value {
                            width: 35%;
                            color: #27ae60;
                        }
                        
                        .print-result {
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        
                        .print-result-units {
                            font-size: 8.5pt;
                            margin-left: 4px;
                            color: #7f8c8d;
                        }
                        
                        .units {
                            font-size: 8.5pt;
                            color: #7f8c8d;
                            font-style: italic;
                        }
                        
                        .additional-notes {
                            background: #fff8e1;
                            padding: 15px;
                            border-left: 5px solid #f39c12;
                            margin-top: 20px;
                            font-size: 10pt;
                            page-break-inside: avoid;
                        }
                        
                        .notes-title {
                            color: #e67e22;
                            margin-bottom: 10px;
                            font-size: 11pt;
                        }
                        
                        /* FIXED FOOTER FOR EVERY PAGE */
                        .print-footer {
                            position: fixed !important;
                            bottom: 0 !important;
                            left: 0 !important;
                            right: 0 !important;
                            width: 100% !important;
                            padding: 8px 15mm !important;
                            font-size: 7.5pt !important;
                            color: #5d6d7e !important;
                            border-top: 2px solid #e0f0ff !important;
                            background: white !important;
                            z-index: 100 !important;
                            text-align: center !important;
                            height: 20mm !important;
                            box-sizing: border-box !important;
                            page-break-inside: avoid !important;
                        }
                        
                        .print-footer-content {
                            display: flex !important;
                            justify-content: space-between !important;
                            align-items: center !important;
                            height: 100% !important;
                        }
                        
                        .footer-left, .footer-center, .footer-right {
                            flex: 1 !important;
                            padding: 0 8px !important;
                        }
                        
                        .footer-left {
                            text-align: left !important;
                        }
                        
                        .footer-center {
                            text-align: center !important;
                            border-left: 1px solid #eee !important;
                            border-right: 1px solid #eee !important;
                        }
                        
                        .footer-right {
                            text-align: right !important;
                        }
                        
                        .dropdown-result.positive {
                            background: #ffeaea;
                            color: #e74c3c;
                            padding: 2px 6px;
                            border-radius: 4px;
                        }
                        
                        .dropdown-result.negative {
                            background: #eaffea;
                            color: #27ae60;
                            padding: 2px 6px;
                            border-radius: 4px;
                        }
                        
                        @page {
                            margin: 15mm 15mm 25mm 15mm !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    <!-- Header -->
                    <div class="header">
                        <h1 class="clinic-name">AVINASH HOSPITAL</h1>
                        <div class="doctor-info">
                            <p><strong>Dr. N C Patel</strong> MBBS, DMCW, MD (Pathology & Microbiology)</p>
                            <p>Consultant Pathologist: Avinash Hospital, Bishra Road, Rourkela</p>
                        </div>
                        <div class="address">
                            <p>Pathology Clinic Address: Avinash Hospital, Bishra Road Rourkela-769001</p>
                        </div>
                        <div class="reg-no">Registration No: 917/08</div>
                    </div>
                    
                    <!-- Patient Info -->
                    <div class="print-patient-info">
                        <table>
                            <tr>
                                <td class="label">Serial No:</td>
                                <td>${slNo || 'N/A'}</td>
                                <td class="label">Date:</td>
                                <td>${reportDate}</td>
                                <td class="label">Ref. No:</td>
                                <td>${referenceNo || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td class="label">Patient Name:</td>
                                <td>${patientName || 'N/A'}</td>
                                <td class="label">Sex/Age:</td>
                                <td>${patientSex || 'N/A'}${patientAge ? ' / ' + patientAge + ' years' : ''}</td>
                                <td class="label">Sample:</td>
                                <td>${sampleType || 'Blood'}</td>
                            </tr>
                            <tr>
                                <td class="label">Referred by:</td>
                                <td colspan="5">${doctorName || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>`;
            
            // Add test sections that have data
            for (const section in tests) {
                const sectionElement = document.getElementById(`section-${section}`);
                if (sectionElement) {
                    const filledRows = sectionElement.querySelectorAll('.test-row:not(.empty-row)');
                    if (filledRows.length > 0) {
                        const sectionName = sectionElement.querySelector('.section-header h3').textContent.split(' ')[0];
                        html += `
                            <div class="test-section">
                                <div class="section-header">${sectionName}</div>
                                <div class="section-content">
                                    <table class="test-table">
                                        <thead>
                                            <tr>
                                                <th width="45%">Test Name</th>
                                                <th width="20%">Test Result</th>
                                                <th width="35%">Normal Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                        
                        // Add filled rows
                        tests[section].forEach(test => {
                            const input = document.getElementById(`test_${test.id}`);
                            const printResult = document.getElementById(`print_test_${test.id}`);
                            const printUnits = document.getElementById(`print_units_${test.id}`);
                            
                            if (input && input.value.trim()) {
                                let resultClass = '';
                                if (input.tagName === 'SELECT') {
                                    const lowerValue = input.value.toLowerCase();
                                    if (lowerValue.includes('positive')) resultClass = 'positive';
                                    else if (lowerValue.includes('negative') || lowerValue.includes('non-reactive')) resultClass = 'negative';
                                    else if (lowerValue.includes('weak') || lowerValue.includes('borderline')) resultClass = 'weak-positive';
                                }
                                
                                html += `
                                    <tr>
                                        <td class="test-name">${test.id}. ${test.name}</td>
                                        <td class="test-input">
                                            <span class="print-result dropdown-result ${resultClass}">${input.value}</span>
                                            ${test.units ? `<span class="print-result-units">${test.units}</span>` : ''}
                                        </td>
                                        <td class="normal-value">
                                            ${test.normalValue} ${test.units ? `<span class="units">${test.units}</span>` : ''}
                                        </td>
                                    </tr>`;
                            }
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>`;
                    }
                }
            }
            
            // Add additional notes if present
            if (additionalNotes.trim()) {
                html += `
                    <div class="additional-notes">
                        <h3 class="notes-title">Additional Notes</h3>
                        <p>${additionalNotes.replace(/\n/g, '<br>')}</p>
                    </div>`;
            }
            
            // Close container and add footer
            html += `
                </div>
                
                <!-- Footer - FIXED FOR EVERY PAGE -->
                <div class="print-footer">
                    <div class="print-footer-content">
                        <div class="footer-left">
                            <p>Report Generated: ${reportDate}</p>
                            <p>Serial No: ${slNo || 'N/A'} | Ref: ${referenceNo || 'N/A'}</p>
                        </div>
                        <div class="footer-center">
                            <p><strong>Dr. N C Patel</strong></p>
                            <p>MBBS, DMCW, MD (Pathology & Microbiology)</p>
                            <p>Bishra Road, Rourkela-1 | Reg. No: 917/08</p>
                        </div>
                        <div class="footer-right">
                            <p>Signature: _________________</p>
                            <p><i class="fas fa-stamp"></i> Hospital Stamp</p>
                        </div>
                    </div>
                </div>
            </body>
            </html>`;
            
            return html;
        }

        // Print preview
        function printPreview() {
            // Validate required fields
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            
            if (!patientName || !slNo) {
                alert('Please enter patient name and serial number before preview.');
                return;
            }
            
            // Count filled tests
            let filledTestCount = 0;
            document.querySelectorAll('.test-input input, .test-input select').forEach(input => {
                if (input.value.trim()) filledTestCount++;
            });
            
            if (filledTestCount === 0) {
                alert('Please enter at least one test result before preview.');
                return;
            }
            
            // Generate print HTML
            const printHTML = generatePrintHTML();
            
            // Open in iframe for preview
            const iframe = document.getElementById('printPreviewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            iframeDoc.open();
            iframeDoc.write(printHTML);
            iframeDoc.close();
            
            // Show modal
            document.getElementById('printPreviewModal').style.display = 'flex';
        }

        // Close print preview
        function closePrintPreview() {
            document.getElementById('printPreviewModal').style.display = 'none';
        }

        // Print from preview
        function printFromPreview() {
            const iframe = document.getElementById('printPreviewFrame');
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
        }

        // Print report
        function printReport() {
            // Validate required fields
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            
            if (!patientName) {
                alert('Please enter patient name before printing.');
                document.getElementById('patientName').focus();
                return;
            }
            
            if (!slNo) {
                alert('Please enter serial number before printing.');
                document.getElementById('slNo').focus();
                return;
            }
            
            // Count filled tests
            let filledTestCount = 0;
            document.querySelectorAll('.test-input input, .test-input select').forEach(input => {
                if (input.value.trim()) filledTestCount++;
            });
            
            if (filledTestCount === 0) {
                alert('Please enter at least one test result before printing.');
                return;
            }
            
            // Generate print HTML and open in new window for printing
            const printHTML = generatePrintHTML();
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };
        }

        // Save as JSON
        function saveAsJSON() {
            // Validate required fields
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            
            if (!patientName || !slNo) {
                alert('Please enter patient name and serial number before saving.');
                return;
            }
            
            // Collect all data
            const reportData = {
                patientInfo: {
                    slNo: document.getElementById('slNo').value.trim(),
                    reportDate: document.getElementById('reportDate').value,
                    patientName: document.getElementById('patientName').value.trim(),
                    patientSex: document.getElementById('patientSex').value,
                    patientAge: document.getElementById('patientAge').value.trim(),
                    referenceNo: document.getElementById('referenceNo').value.trim(),
                    doctorName: document.getElementById('doctorName').value.trim(),
                    sampleType: document.getElementById('sampleType').value.trim(),
                    clinicalNotes: document.getElementById('clinicalNotes').value.trim(),
                    additionalNotes: document.getElementById('additionalNotes').value.trim()
                },
                testResults: {},
                timestamp: new Date().toISOString()
            };
            
            // Collect test results
            for (const section in tests) {
                reportData.testResults[section] = [];
                tests[section].forEach(test => {
                    const input = document.getElementById(`test_${test.id}`);
                    if (input && input.value.trim()) {
                        reportData.testResults[section].push({
                            id: test.id,
                            name: test.name,
                            result: input.value.trim(),
                            units: test.units,
                            normalValue: test.normalValue
                        });
                    }
                });
            }
            
            // Generate unique filename
            const timestamp = new Date().getTime();
            const filename = `Pathology_Report_${patientName.replace(/\s+/g, '_')}_${slNo}_${timestamp}.json`;
            
            // Create and download file
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Also save to localStorage for quick retrieval
            try {
                const savedReports = JSON.parse(localStorage.getItem('pathologyReports') || '[]');
                savedReports.push({
                    id: timestamp,
                    filename: filename,
                    patientName: patientName,
                    slNo: slNo,
                    date: new Date().toLocaleDateString(),
                    data: reportData
                });
                
                // Keep only last 100 reports
                if (savedReports.length > 10000) {
                    savedReports.shift();
                }
                
                localStorage.setItem('pathologyReports', JSON.stringify(savedReports));
                
                alert(`Report saved as JSON successfully!\n\nFilename: ${filename}`);
            } catch (e) {
                alert(`Report saved as JSON!\n\nFilename: ${filename}\n\nNote: Could not save to browser storage due to size limitations.`);
            }
        }

        // Save as PDF using html2canvas and jsPDF
        function saveAsPDF() {
            // Validate required fields
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            
            if (!patientName || !slNo) {
                alert('Please enter patient name and serial number before saving as PDF.');
                return;
            }
            
            // Count filled tests
            let filledTestCount = 0;
            document.querySelectorAll('.test-input input, .test-input select').forEach(input => {
                if (input.value.trim()) filledTestCount++;
            });
            
            if (filledTestCount === 0) {
                alert('Please enter at least one test result before saving as PDF.');
                return;
            }
            
            // Show loading message
            const originalBtnText = document.querySelector('.btn-danger').innerHTML;
            document.querySelector('.btn-danger').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            document.querySelector('.btn-danger').disabled = true;
            
            // Generate print HTML
            const printHTML = generatePrintHTML();
            
            // Create temporary iframe to render content for PDF
            const tempIframe = document.createElement('iframe');
            tempIframe.style.position = 'absolute';
            tempIframe.style.left = '-9999px';
            tempIframe.style.top = '-9999px';
            tempIframe.style.width = '210mm';
            tempIframe.style.height = '297mm';
            document.body.appendChild(tempIframe);
            
            const iframeDoc = tempIframe.contentDocument || tempIframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(printHTML);
            iframeDoc.close();
            
            // Wait for iframe to load
            tempIframe.onload = function() {
                html2canvas(tempIframe.contentDocument.body, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // Remove temporary iframe
                    document.body.removeChild(tempIframe);
                    
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Add image to PDF
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    // Generate filename
                    const timestamp = new Date().getTime();
                    const filename = `Pathology_Report_${patientName.replace(/\s+/g, '_')}_${slNo}_${timestamp}.pdf`;
                    
                    // Save PDF
                    pdf.save(filename);
                    
                    // Restore button
                    document.querySelector('.btn-danger').innerHTML = originalBtnText;
                    document.querySelector('.btn-danger').disabled = false;
                    
                    alert(`PDF saved successfully!\n\nFilename: ${filename}`);
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    document.querySelector('.btn-danger').innerHTML = originalBtnText;
                    document.querySelector('.btn-danger').disabled = false;
                    alert('Error generating PDF. Please try printing instead.');
                    document.body.removeChild(tempIframe);
                });
            };
        }

        // Save PDF from preview
        function savePDFFromPreview() {
            const patientName = document.getElementById('patientName').value.trim();
            const slNo = document.getElementById('slNo').value.trim();
            
            // Show loading in modal
            const modalBtn = document.querySelector('.modal-action-btn:nth-child(2)');
            const originalText = modalBtn.innerHTML;
            modalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            modalBtn.disabled = true;
            
            // Get content from iframe
            const iframe = document.getElementById('printPreviewFrame');
            const iframeBody = iframe.contentDocument.body;
            
            html2canvas(iframeBody, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Add image to PDF
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Generate filename
                const timestamp = new Date().getTime();
                const filename = `Pathology_Report_${patientName.replace(/\s+/g, '_')}_${slNo}_${timestamp}.pdf`;
                
                // Save PDF
                pdf.save(filename);
                
                // Restore button
                modalBtn.innerHTML = originalText;
                modalBtn.disabled = false;
                
                alert(`PDF saved successfully!\n\nFilename: ${filename}`);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                modalBtn.innerHTML = originalText;
                modalBtn.disabled = false;
                alert('Error generating PDF. Please try printing instead.');
            });
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + P to print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printReport();
            }
            
            // Ctrl + S to save as JSON
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAsJSON();
            }
            
            // Ctrl + D to save as PDF
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                saveAsPDF();
            }
            
            // Ctrl + V for preview
            if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                printPreview();
            }
            
            // Ctrl + C to clear
            if (e.ctrlKey && e.key === 'c') {
                e.preventDefault();
                clearAll();
            }
            
            // Esc to close preview
            if (e.key === 'Escape' && document.getElementById('printPreviewModal').style.display === 'flex') {
                closePrintPreview();
            }
        });
    </script>
</body>
</html>